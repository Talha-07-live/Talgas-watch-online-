<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Talha's Stream</title>
<link rel="icon" href="https://s10.gifyu.com/images/SrMU9.png" />
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css" />
<style>
  body {
    margin: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    color: white;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 10px;
    box-sizing: border-box;
    text-align: center;
  }
  #main-title {
    font-weight: 700;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    text-shadow: 0 0 15px #00ffa3;
    color: #00ffa3;
  }
  #file-name {
    font-size: clamp(0.7rem, 2vw, 1rem);
    font-weight: 550;
    color: #a0f4c1;
    margin-top: 4px;
    word-break: break-word;
  }
  #player-container {
    width: 100%;
    max-width: 900px;
    margin: 20px auto;
    box-shadow: 0 0 30px #00ffa3aa;
    border-radius: 12px;
    overflow: hidden;
  }
  video {
    border-radius: 12px;
    width: 100%;
    height: auto;
  }
  p.status { color: #66ffc9cc; font-weight: 600; }
  footer { margin: 15px 0; font-size: 0.8rem; }
</style>
</head>
<body>
<h1 id="main-title">Talha's Stream</h1>
<p id="file-name">Loading file name...</p>

<div id="player-container">
  <video id="player" playsinline webkit-playsinline preload="metadata" poster="https://s10.gifyu.com/images/SrMU9.png">
    <source id="source" src="" type="video/mp4" />
  </video>
</div>
<p class="status" id="status">Loading video...</p>
<p class="status note">
  Note: If the video plays without sound, your browser may not support EAC3 audio. Please download for full audio.
</p>
<footer>©2020–2025 Talha's Collection | Made By Talha</footer>

<script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>
<script>
const keyString = "Talha<what!".padEnd(32);
const encoder = new TextEncoder();
const rawKey = encoder.encode(keyString);

function getParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

async function importKey() {
  return await crypto.subtle.importKey(
    'raw',
    rawKey.slice(0, 32),
    'AES-GCM',
    false,
    ['decrypt']
  );
}

async function decryptPayload(data) {
  const binaryStr = atob(data);
  const buffer = new Uint8Array(binaryStr.length);
  for (let i = 0; i < binaryStr.length; i++) buffer[i] = binaryStr.charCodeAt(i);
  const iv = buffer.slice(0, 12);
  const encryptedData = buffer.slice(12);
  const cryptoKey = await importKey();
  const decryptedBuffer = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv },
    cryptoKey,
    encryptedData
  );
  return new TextDecoder().decode(decryptedBuffer);
}

async function setupPlayer() {
  const encryptedData = getParam('Talha');
  const statusEl = document.getElementById('status');

  if (!encryptedData) {
    statusEl.textContent = 'No video data found in URL. *Contact My Owner "Talha"*';
    return;
  }

  try {
    const decryptedText = await decryptPayload(encryptedData);
    const data = JSON.parse(decryptedText);

    document.getElementById('file-name').textContent = data.name || 'Unknown File *Contact My Owner "Talha"*';
    const sourceEl = document.getElementById('source');
    sourceEl.src = data.url;

    const player = new Plyr('#player', {
      controls: [
        'play-large','rewind','play','fast-forward','progress','current-time',
        'mute','volume','settings','pip','fullscreen'
      ],
      settings: ['quality','speed','loop','audio'],
      seekTime: 10
    });

    const videoEl = document.getElementById('player');
    videoEl.load();
    player.play();

    // Audio track selection from audios array
    if (Array.isArray(data.audios) && data.audios.length > 0) {
      let audioMenu = {};
      data.audios.forEach((track, index) => {
        audioMenu[index] = track.label || `Track ${index+1}`;
      });

      let currentAudio = new Audio();
      currentAudio.crossOrigin = "anonymous";

      player.on('ready', () => {
        player.settings.addSetting('audio', audioMenu, (selected) => {
          const selectedTrack = data.audios[selected];
          if (selectedTrack) {
            currentAudio.pause();
            currentAudio = new Audio(selectedTrack.url);
            currentAudio.crossOrigin = "anonymous";
            currentAudio.currentTime = videoEl.currentTime;
            currentAudio.play();
            // Sync video & audio time
            videoEl.ontimeupdate = () => {
              if (Math.abs(currentAudio.currentTime - videoEl.currentTime) > 0.3) {
                currentAudio.currentTime = videoEl.currentTime;
              }
            };
          }
          player.settings.hide();
        });

        // Default play first audio
        const firstTrack = data.audios[0];
        if (firstTrack) {
          currentAudio = new Audio(firstTrack.url);
          currentAudio.crossOrigin = "anonymous";
          currentAudio.play();
          videoEl.ontimeupdate = () => {
            if (Math.abs(currentAudio.currentTime - videoEl.currentTime) > 0.3) {
              currentAudio.currentTime = videoEl.currentTime;
            }
          };
        }
      });
    }

    // Disable right click and devtools
    videoEl.addEventListener('contextmenu', e => e.preventDefault());
    window.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J'].includes(e.key)) || (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
      }
    });

    statusEl.textContent = 'Video loaded successfully. Enjoy!';

  } catch (err) {
    document.getElementById('status').textContent = 'Failed to load video: ' + err.message;
  }
}

window.onload = setupPlayer;
</script>
</body>
</html>
